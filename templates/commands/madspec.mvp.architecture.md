---
description: MVP - Этап 3 - Проектирование архитектуры, структуры проекта, модели данных и API контрактов
handoffs: 
  - label: Создать план реализации
    agent: madspec.mvp.plan
    prompt: Создай план реализации на основе архитектуры
scripts:
  sh: scripts/bash/get-branch.sh
  ps: scripts/powershell/get-branch.ps1
---

## Пользовательский ввод

```text
$ARGUMENTS
```

Ты **ОБЯЗАН** учитывать пользовательский ввод перед продолжением (если он не пустой).

## Правила диалога (обязательно)

- **Задавай вопросы строго по одному**: в каждом твоем сообщении должен быть **ровно 1 вопрос**, который требует ответа.
- **Не выдавай список вопросов заранее** (никаких длинных анкет/чек-листов вопросов за раз).
- Если нужен выбор, задай **один вопрос** и предложи **не больше 3–5 вариантов** (или попроси свободный ответ).
- **Дожидайся ответа** и только затем задавай следующий вопрос.
- Если ответ неполный — задай **один уточняющий вопрос**, а не несколько сразу.

## Описание

На этом этапе **MADSpec (MADSpec Framework)** создается детальная архитектура **MVP (Minimum Viable Product)** проекта на основе:

**Режим MVP**: Эта команда предназначена для разработки нового проекта с нуля. Все артефакты сохраняются в `.madspec/<BRANCH>/`, где `<BRANCH>` - имя текущей ветки разработки.
- Концепции проекта
- Утвержденного дизайна UI
- Выбранного технологического стека

Этот этап определяет, **КАК** будет организован код и данные в проекте.

## Предварительные условия

- Должен существовать `.madspec/<BRANCH>/concept.md` (где `<BRANCH>` определяется через скрипт)
- Должен существовать `.madspec/<BRANCH>/ui-design.md`
- Должен существовать `.madspec/<BRANCH>/tech-stack.md`
- **Если файлы отсутствуют**, то предложи выполнить предыдущие этапы MVP (`/madspec.mvp.concept`, `/madspec.mvp.design`, `/madspec.mvp.tech`)

## Цель этапа

Создать детальную архитектуру, включающую:
- Структуру директорий проекта
- Модель данных (на основе UI дизайна)
- API контракты (на основе UI дизайна)
- Внешние зависимости и интеграции
- Принципы организации кода

## Рабочий процесс

### ⚠️ КРИТИЧЕСКИ ВАЖНО: Оркестрация субагентов и агентских навыков

**ОБЯЗАТЕЛЬНО ВЫПОЛНИ ЭТОТ ШАГ ПЕРВЫМ ПЕРЕД ВСЕМИ ОСТАЛЬНЫМИ ДЕЙСТВИЯМИ:**

1. **Загрузи агенсткий навык (agent skills из из директории .x/skills, где x - название используемой среды разработки. Например - cursor, opencode и т.д.) оркестрации субагентов (`subagents_orchestrator`)**, который отвечает за распределения частей выполняемой команды по специализированным субагентам. 

2. **Используй навык `subagents_orchestrator` для анализа текущей задачи**:
   - Передай навыку описание текущей задачи 
   - Навык проанализирует задачу и вернет структурированный JSON-ответ с рекомендациями:
     - Каких субагентов использовать
     - Режим выполнения (parallel/sequential)
     - Обоснование выбора
   - **ВАЖНО**: Если навык вернул `status: "no_agents"` или список субагентов пуст, переходи к обычному выполнению задачи без использования субагентов

3. **При запуске субагентов**:
  - Если для запускаемого субагента имеется подходящий навык, **ОБЯЗАТЕЛЬНО** передай в промпте, отправляемом на вход субагента, команду по его загрузке
  - **КРИТИЧЕСКИ ВАЖНО**: При вызове инструментов, отвечающих за запуск субагентов, **ВСЕГДА** передавай следующие параметры (если они поддерживаются):
     - `description` - краткое описание задачи
     - `prompt` - детальные инструкции для субагента
     - Тип субагента

4. **Fallback поведение**:
   - Если субагенты недоступны или навык не может быть использован, продолжи обычное выполнение задачи

---

0. **Определение текущей ветки**:
   - **ВАЖНО**: Перед началом работы определи текущую ветку, выполнив `{SCRIPT}` из корня проекта
   - Скрипт возвращает имя ветки через stdout
   - Используй результат выполнения скрипта (имя ветки) для формирования путей к артефактам
   - Все пути к артефактам должны быть в формате `.madspec/<BRANCH>/...`, где `<BRANCH>` - это имя ветки, полученное из скрипта
   - Если ни скрипт, ни файл недоступны, используй значение по умолчанию `main`
   - Сохрани имя ветки для использования в дальнейших шагах

1. **Загрузка контекста**:
   - Прочитай все предыдущие артефакты:
     - `.madspec/<BRANCH>/concept.md` (где `<BRANCH>` - имя ветки, определенное в шаге 0)
     - `.madspec/<BRANCH>/ui-design.md`
     - `.madspec/<BRANCH>/tech-stack.md`
     - `.madspec/<BRANCH>/project-context.md`
   - **ВАЖНО**: Проанализируй HTML прототипы в `.madspec/<BRANCH>/ui-prototype/`:
     - Открой каждый HTML файл и извлеки информацию о:
       - Формах и полях ввода (какие данные отправляются)
       - Элементах отображения (какие данные получаются)
       - Действиях пользователя (какие операции выполняются)
       - Навигации между экранами

1. **Проектирование структуры проекта**:
   - На основе выбранного стека и подхода к организации (из этапа tech)
   - Создай детальную структуру директорий
   - Объясни назначение каждой директории

2. **Проектирование модели данных**:
   - На основе UI дизайна определи:
     - Какие сущности нужны (User, Product, Order, и т.д.)
     - Какие поля у каждой сущности
     - Связи между сущностями
     - Правила валидации
     - Состояния и переходы состояний (если применимо)
   - Создай `.madspec/<BRANCH>/data-model.md` с описанием моделей, структурой базы данных и связью между таблицами

3. **Проектирование API контрактов**:
   - На основе HTML прототипов и UI дизайна определи:
     - Какие эндпоинты нужны для каждого экрана (анализируй формы и действия в прототипах)
     - Методы HTTP (GET, POST, PUT, DELETE)
     - Структура запросов и ответов (извлеки из полей форм в прототипах)
     - Коды ошибок
   - **КРИТИЧНО**: Используй HTML прототипы как источник истины - если в прототипе нет элемента, не создавай для него эндпоинт
   - Создай директорию `.madspec/<BRANCH>/contracts/`
   - Для каждого эндпоинта создай файл с описанием контракта
   - Используй формат OpenAPI/Swagger, если возможно
   - Свяжи каждый контракт с соответствующим экраном из прототипа

4. **Объединение контрактов в один документ**:
  - **КРИТИЧНО**: объедини все API контракты (Rest API) в один файл в нотации OpenAPI v.3 - `.madspec/<BRANCH>/contracts/openapi.yaml`

5. **Определение внешних зависимостей**:
   - Какие внешние сервисы/API нужны
   - Какие библиотеки потребуются
   - Какие инструменты разработки необходимы

6. **Создание документации архитектуры**:
   - Загрузи шаблон `.madspec/templates/architecture-template.md` (шаблоны хранятся в корне `.madspec/templates/`)
   - Заполни все разделы:
     - Структура проекта
     - Модель данных (ссылка на data-model.md)
     - API контракты (ссылки на contracts/)
     - Внешние зависимости
     - Принципы организации кода
     - Сохрани в `.madspec/<BRANCH>/architecture.md`

7. **Валидация архитектуры**:
   
   **ВАЖНО**: Перед сохранением файлов выполни полную валидацию архитектуры по следующему чек-листу:
   
   - [ ] **Все экраны из прототипов имеют соответствующие эндпоинты**
     - Для каждого экрана из HTML прототипов есть необходимые эндпоинты
     - Эндпоинты покрывают все действия пользователя на экране
     - **Если не выполнено**: создай недостающие эндпоинты
   
   - [ ] **Модель данных покрывает все требования UI**
     - Все данные, отображаемые в UI, есть в модели данных
     - Все данные, вводимые в UI, есть в модели данных
     - Модель данных соответствует структуре данных в прототипах
     - **Если не выполнено**: дополните модель данных
   
   - [ ] **Структура проекта соответствует выбранному стеку**
     - Структура директорий соответствует выбранным технологиям
     - Организация кода соответствует подходу из этапа tech
     - **Если не выполнено**: пересмотри структуру проекта
   
   - [ ] **API контракты соответствуют элементам из прототипов**
     - Все формы из прототипов имеют соответствующие POST/PUT эндпоинты
     - Все поля форм покрыты в структуре запросов
     - Все данные для отображения покрыты в структуре ответов
     - **Если не выполнено**: обнови API контракты
   
   - [ ] **Нет лишних эндпоинтов**
     - **КРИТИЧНО**: Созданы эндпоинты для элементов, которых нет в прототипах
     - Каждый эндпоинт соответствует конкретному экрану/действию
     - **Если есть лишние эндпоинты**: удали их или обоснуй необходимость
   
   - [ ] **Модель данных логична и нормализована**
     - Сущности имеют логичную структуру
     - Связи между сущностями определены
     - Нет избыточной нормализации или денормализации
     - **Если не выполнено**: пересмотри модель данных
   
   - [ ] **Архитектура расширяема**
     - Легко добавить новые функции
     - Структура поддерживает рост проекта
     - **Если не выполнено**: обсудите расширяемость архитектуры
   
   - [ ] **Документация архитектуры создана**
     - Файл `.madspec/<BRANCH>/architecture.md` создан и заполнен
     - Файл `.madspec/<BRANCH>/data-model.md` создан
     - API контракты созданы в `.madspec/<BRANCH>/contracts/`
     - **Если не выполнено**: создай документацию

   **Если валидация не пройдена:**
   - Укажи конкретные пункты, которые не выполнены
   - Предложи конкретные исправления
   - **НЕ ПЕРЕХОДИ** к следующему этапу до прохождения валидации
   
   **Если валидация пройдена:**
   - Подтвердите успешную валидацию

8. **Обновление project-context.md**:
   - Обнови `.madspec/<BRANCH>/project-context.md`:
     - Установи текущий этап: "architecture"
     - Обнови статус этапа архитектуры: "Завершен"

9. **Сохранение артефактов**:
   - Сохрани `.madspec/<BRANCH>/architecture.md`
   - Сохрани `.madspec/<BRANCH>/data-model.md`
   - Сохрани контракты в `.madspec/<BRANCH>/contracts/`
   - Обнови `.madspec/<BRANCH>/project-context.md` (только навигацию)

10. **Отчет**:
   - Выведи пути к созданным файлам
   - Предложи перейти к следующему этапу (план реализации)

## Правила

- **СЛЕДУЙ** UI дизайну - не создавай эндпоинты, которых нет в дизайне
- **НАЧИНАЙ ПРОСТО** - избегай преждевременной оптимизации
- **ДОКУМЕНТИРУЙ** все решения с обоснованием
- Используй принципы из выбранного подхода организации кода

## Выходные артефакты

- `.madspec/<BRANCH>/architecture.md` - основная документация архитектуры (где `<BRANCH>` - имя текущей ветки)
- `.madspec/<BRANCH>/data-model.md` - модель данных
- `.madspec/<BRANCH>/contracts/` - директория с API контрактами
- `.madspec/<BRANCH>/contracts/openapi.yaml` - объединенный файл API контрактов
- `.madspec/<BRANCH>/project-context.md` - обновленный контекст проекта

## Подсказки и помощь

### Контекстные подсказки
При возникновении ошибок валидации система автоматически предложит подсказки. Например, если созданы контракты для элементов, которых нет в прототипе, система предложит проверить соответствие.

## Следующий этап

После создания архитектуры переходите к `/madspec.mvp.plan` для разбивки на шаги реализации.