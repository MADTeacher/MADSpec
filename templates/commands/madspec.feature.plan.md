---
description: Feature - Планирование новой функциональности - создание плана реализации с разбивкой на последовательность шагов на основе анализа проекта
handoffs: 
  - label: Начать реализацию
    agent: madspec.feature.implement
    prompt: Начни реализацию с шага [N]
scripts:
  sh: scripts/bash/get-branch.sh
  ps: scripts/powershell/get-branch.ps1
---

## Пользовательский ввод

```text
$ARGUMENTS
```

Ты **ОБЯЗАН** учитывать пользовательский ввод перед продолжением (если он не пустой).

## Правила диалога (обязательно)

- **Задавай вопросы строго по одному**: в каждом твоем сообщении должен быть **ровно 1 вопрос**, который требует ответа.
- **Не выдавай список вопросов заранее** (никаких длинных анкет/чек-листов вопросов за раз).
- Если нужен выбор, задай **один вопрос** и предложи **не больше 3–5 вариантов** (или попроси свободный ответ).
- **Дожидайся ответа** и только затем задавай следующий вопрос.
- Если ответ неполный — задай **один уточняющий вопрос**, а не несколько сразу.

## КРИТИЧЕСКИ ВАЖНО: Запрет изменения currentImplementStep

**НИ ПРИ КАКИХ ОБСТОЯТЕЛЬСТВАХ НЕ ИЗМЕНЯЙ `currentImplementStep` в файле `progress.json`.**

- Эта команда предназначена **ТОЛЬКО** для планирования шагов
- Поле `currentImplementStep` управляется другими командами (например, `madspec.feature.implement`)
- При обновлении `progress.json` **ОБЯЗАТЕЛЬНО** сохраняй значение `currentImplementStep` без изменений
- Если `currentImplementStep` имеет значение `null` — оставь его `null`
- Если `currentImplementStep` содержит имя шага — оставь его без изменений
- **НАРУШЕНИЕ ЭТОГО ПРАВИЛА НЕДОПУСТИМО**

## Описание

На этом этапе **MADSpec (MADSpec Framework)** новая функциональность разбивается на конкретные шаги реализации с использованием **инкрементального подхода**. Каждый запуск команды создает только **один новый шаг**.

**Источник правды:** `project-analysis.md` — в нем определены:
- Функциональные требования (P1/P2/P3) с привязкой к файлам
- Точки интеграции, файлы для модификации, новые файлы

Каждый шаг должен быть:
- Независимо тестируемым
- Имеющим четкие критерии завершения
- Содержащим описание что нужно сделать
- Включающим тесты для валидации
- Покрывающим хотя бы одну функцию из добавляемой функциональности

## Предварительные условия

Должен существовать `.madspec/feature/<feature-branch>/` с артефактами от `madspec.feature.init`:
- `project-analysis.md` — **ключевой** — функции P1/P2/P3 + точки интеграции
- `architecture.md` — архитектура изменений
- `tech-stack.md` — технологии
- `concept.md` — опционально, дополнительный контекст
- `project-context.md` — навигация
- `memory/progress.json` — состояние планирования и прогресса

Если файлы отсутствуют, предложи выполнить `/madspec.feature.init`

## Цель этапа

Создать детальный план реализации инкрементально на основе `project-analysis.md`:
- Разбивает задачи на логические шаги (по одному за запуск)
- Определяет зависимости между шагами на основе функций из project-analysis.md

## Рабочий процесс

### ⚠️ КРИТИЧЕСКИ ВАЖНО: Оркестрация субагентов и агентских навыков

**ОБЯЗАТЕЛЬНО ВЫПОЛНИ ЭТОТ ШАГ ПЕРВЫМ ПЕРЕД ВСЕМИ ОСТАЛЬНЫМИ ДЕЙСТВИЯМИ:**

1. **Загрузи агенсткий навык (agent skills из из директории .x/skills, где x - название используемой среды разработки. Например - cursor, opencode и т.д.) оркестрации субагентов (`subagents_orchestrator`)**, который отвечает за распределения частей выполняемой команды по специализированным субагентам. 

**ВНИМАНИЕ** - `subagents_orchestrator` **НЕ СУБАГЕНТ (subagent), А НАВЫК!!!!! ЕГО НЕЛЬЗЯ ПЫТАТЬСЯ ЗАПУСКАТЬ КАК СУБАГЕНТА!!! ЕГО НАДО ИСПОЛЬЗОВАТЬ ДЛЯ ТОГО ЧТОБЫ ОПРЕДЕЛИТЬ МОЖНО ЛИ ПОРУЧИТЬ ЗАДАЧУ ВЫПОЛНИТЬ ПОМОЩЬНИКАМ - ДРУГИМ СУБАГЕНТАМ ИЛИ НЕТ, А ЕСЛИ МОЖНО, ТО КАКИМ И КАК (ПАРАЛЛЕЛЬНО/ПОСЛЕДОВАТЕЛЬНО)**

2. **Проанализируй текущую задачу и примени к ней навык `subagents_orchestrator`**:
   - Навык проанализирует задачу и вернет структурированный JSON-ответ с рекомендациями:
     - Каких субагентов использовать
     - Режим выполнения (parallel/sequential)
     - Обоснование выбора
   - **ВАЖНО**: Если навык вернул `status: "no_agents"` или список субагентов пуст, переходи к обычному выполнению задачи без использования субагентов

3. **При запуске субагентов**:
  - Если для запускаемого субагента имеется подходящий навык, **ОБЯЗАТЕЛЬНО** передай в промпте, отправляемом на вход субагента, команду по его загрузке
  - **КРИТИЧЕСКИ ВАЖНО**: При вызове инструментов, отвечающих за запуск субагентов, **ВСЕГДА** передавай следующие параметры (если они поддерживаются):
     - `description` - краткое описание задачи
     - `prompt` - детальные инструкции для субагента
     - Тип субагента

4. **Fallback поведение**:
   - Если субагенты недоступны или навык не может быть использован, продолжи обычное выполнение задачи

⚠️⚠️⚠️ **ЕСЛИ ЗАГРУЖАЕШЬ НАВЫК ОРКЕСТРАЦИИ — ИСПОЛЬЗУЙ ЕГО РЕКОМЕНДАЦИИ, А НЕ ИГНОРИРУЙ**

---

**Инкрементальный подход:** Каждый запуск создает только **один новый шаг**.

0. **Определение текущей ветки**:
   - **ВАЖНО**: Перед началом работы определи текущую ветку, выполнив `{SCRIPT}` из корня проекта
   - Скрипт возвращает имя ветки через stdout
   - Используй результат выполнения скрипта (имя ветки) для формирования путей к артефактам
   - Все пути к артефактам должны быть в формате `.madspec/<BRANCH>/...`, где `<BRANCH>` - это имя ветки, полученное из скрипта
   - Если ни скрипт, ни файл недоступны, используй значение по умолчанию `main`
   - Сохрани имя ветки для использования в дальнейших шагах

1. **Проверка состояния планирования:**
   - Проверь `.madspec/feature/<feature-branch>/memory/progress.json`
       - Если не существует — создай на основе шаблона `.madspec/templates/planning-state-template.json`
   - Проверь наличие директории `.madspec/feature/<feature-branch>/steps/`
       - Если не существует — создай её
   - Определи режим:
     - **`initial`** — если `plannedSteps` пуст
     - **`incremental`** — если есть запланированные шаги

2. **Загрузка контекста (из артефактов init):**
   
   Прочитай:
   - `.madspec/feature/<feature-branch>/project-analysis.md` — **ключевой**:
     - Функциональные требования P1/P2/P3 с привязкой к файлам
     - Какие файлы модифицировать
     - Какие файлы создать
     - Зависимости между модулями
     - Рекомендации по интеграции
   - `.madspec/feature/<feature-branch>/architecture.md` — структура изменений
   - `.madspec/feature/<feature-branch>/tech-stack.md` — технологии
   - `.madspec/feature/<feature-branch>/concept.md` — опционально, для понимания контекста
   - `.madspec/feature/<feature-branch>/memory/progress.json` — что уже запланировано

3. **Определение следующего шага (из project-analysis.md):**

   На основе `project-analysis.md`:

   - **Функции P1/P2/P3** → определи которые еще не покрыты
   - **Связанные файлы** → распредели по шагам (сгруппируй связанные)
   - **Зависимости** → учти порядок (сначала базовые вещи, потом зависимые)

   Алгоритм:
   - Найди функции из секций P1/P2/P3 в `project-analysis.md`, которые еще не покрыты
   - Сгруппируй функции по связанным файлам (из project-analysis.md)
   - Выбери шаг с наивысшим приоритетом (P1 → P2 → P3)
   - Проверь зависимости (все ли нужные шаги уже запланированы)

4. **Создание шага на основе анализа:**

   Создай директорию `.madspec/feature/<feature-branch>/steps/step-[NN]-[name]/`

   **4.1. `description.md`:**
   ```
   # Шаг [NN]: [Название]
   
   ## Цель
   [Что делаем на этом шаге]
   
   ## Из project-analysis.md
   - Покрываемые функции: [список ID функций из P1/P2/P3]
   - Файлы для модификации: [список из analysis]
   - Новые файлы: [список из analysis]
   
   ## Обоснование
   Почему этот шаг сейчас — приоритет функций, зависимости от файлов
   ```

   **4.2. `tasks.md`:**
   ```
   # Задачи шага [NN]
   
   ## Файлы для модификации
   - [ ] Файл 1 ([причина модификации])
   - [ ] Файл 2 ([причина модификации])
   
   ## Новые файлы
   - [ ] Файл 1 ([что это и зачем])
   - [ ] Файл 2 ([что это и зачем])
   
   ## Интеграция
   - [ ] Связать с существующими модулями (из project-analysis.md)
   - [ ] Соблюсти контракты (из architecture.md)
   ```

   **4.3. `tests.md`:**
   ```
   # Тесты шага [NN]
   
   ## Автоматические тесты
   - [ ] Unit-тесты для новых компонентов/функций
   - [ ] Интеграционные тесты для связей с существующим кодом
   
   ## Ручные проверки
   - [ ] Проверить что файлы из tasks.md созданы/модифицированы
   - [ ] Проверить интеграцию (согласно project-analysis.md)
   ```

   **4.4. `validation.md`:**
   ```
   # Критерии завершения шага [NN]
   
   ## Обязательные
   - [ ] Все задачи из tasks.md выполнены
   - [ ] Файлы созданы согласно описанию
   - [ ] Интеграция с существующим кодом работает
   - [ ] Автоматические тесты проходят
   
   ## Из project-analysis.md
   - [ ] Модификации из "Файлы для модификации" выполнены
   - [ ] Новые файлы из "Новые файлы" созданы
   ```

   **4.5. `planning-context.md` (обязательно):**

   Использовать шаблон из `templates/feature/feature-planning-context-template.md`:

   Скопировать содержимое шаблона и заполнить:
   - Почему этот шаг
   - Зависимости
   - Покрываемые функции (P1/P2/P3 из project-analysis.md)
   - Связанные артефакты
   - Размер
   - Ключевые решения

5. **Обновление прогресса:**

    Обнови `.madspec/feature/<feature-branch>/memory/progress.json`:
    
    **КРИТИЧЕСКИ ВАЖНО**: При обновлении файла **НИ ПРИ КАКИХ ОБСТОЯТЕЛЬСТВАХ НЕ ИЗМЕНЯЙ** значение поля `currentImplementStep`. Прочитай текущее значение `currentImplementStep` из файла и сохрани его без изменений.
    
    ```json
    {
      "currentImplementStep": null,
      "completedSteps": [],
      "plannedSteps": ["step-01-...", "step-02-...", "step-[NN]-[name]"],
      "stepStatus": {},
      "planningMetadata": {
        "lastPlannedStep": "step-[NN]-[name]",
        "planningPhase": "incremental",
        "totalStepsEstimated": null,
        "stepDependencies": {
          "step-[NN]-[name]": ["step-01-...", "step-02-..."]
        },
        "progressMetrics": {
          "p1Coverage": {"covered": 0, "total": 0, "percentage": 0},
          "p2Coverage": {"covered": 0, "total": 0, "percentage": 0},
          "p3Coverage": {"covered": 0, "total": 0, "percentage": 0},
          "overallProgress": 0
        }
      }
    }
    ```

6. **Обновление implementation-plan.md:**

   Добавь новый шаг в план:
   ```markdown
   ## Шаг [NN]: [Название]
   
   **Обоснование:** [из planning-context.md]
   
   **Задачи:** [кратко из tasks.md]
   
   **Тесты:** [кратко из tests.md]
   ```

7. **Визуализация прогресса:**

   Выведи:
   ```
   Прогресс планирования:
   P1 функции: [X/Y] покрыты ([Z%]) ████████░░
   P2 функции: [A/B] покрыты ([C%]) ██████░░░░
   P3 функции: [D/E] покрыты ([F%]) ████░░░░░░

   Запланировано шагов: [N]
   ```

8. **Обновление project-context.md:**

   ```markdown
   ## Текущий этап
   - **Этап**: `plan`
   - **Статус**: Планирование в процессе
   
   ## Шаги реализации
   - [N] запланировано, [M] завершено
   
   ## Прогресс
   P1: [X/Y] | P2: [A/B] | P3: [D/E]
   ```

9. **Валидация шага:**

   - [ ] Описание понятно и связано с project-analysis.md
   - [ ] Задачи конкретные и выполнимые
   - [ ] Тесты определены
   - [ ] Критерии завершения проверяемы
   - [ ] Зависимости учтены
   - [ ] Шаг покрывает функцию из concept.md
   - [ ] Файлы для модификации/создания из analysis учтены
   - [ ] Размер шага адекватный

10. **Отчет:**

    - Путь к шагу: `.madspec/feature/<feature-branch>/steps/step-[NN]-[name]/`
    - Номер и название шага
    - Краткое описание
    - Зависимости
    - Прогресс планирования
    - Вопрос: "Продолжить планирование следующего шага?"

## Правила

- **ИСПОЛЬЗУЙ** `project-analysis.md` как источник правды о функциях и точках интеграции
- **РАЗБИВАЙ** на шаги на основе функций (P1/P2/P3) и связанных файлов
- **УЧИТЫВАЙ** зависимости между файлами/модулями из analysis
- **ГЕНЕРИРУЙ** один шаг за запуск
- **ОБНОВЛЯЙ** progress.json после каждого шага
- **НИ ПРИ КАКИХ ОБСТОЯТЕЛЬСТВАХ НЕ ИЗМЕНЯЙ** `currentImplementStep` в `progress.json` — это поле управляется другими командами

## Структура шага

Каждый шаг содержит:
- `description.md` — что делаем + ссылки на analysis
- `tasks.md` — файлы для модификации/создания
- `tests.md` — тесты
- `validation.md` — критерии завершения
- `planning-context.md` — контекст решений

## Выходные артефакты

- `.madspec/feature/<feature-branch>/steps/step-[NN]-[name]/` — директория шага
- `.madspec/feature/<feature-branch>/steps/step-[NN]-[name]/description.md` — описание шага
- `.madspec/feature/<feature-branch>/steps/step-[NN]-[name]/tasks.md` — задачи шага
- `.madspec/feature/<feature-branch>/steps/step-[NN]-[name]/tests.md` — тесты шага
- `.madspec/feature/<feature-branch>/steps/step-[NN]-[name]/validation.md` — критерии завершения
- `.madspec/feature/<feature-branch>/steps/step-[NN]-[name]/planning-context.md` — контекст планирования
- `.madspec/feature/<feature-branch>/implementation-plan.md` — план реализации (обновляется)
- `.madspec/feature/<feature-branch>/memory/progress.json` — прогресс планирования
- `.madspec/feature/<feature-branch>/project-context.md` — обновленный контекст проекта

## Следующий этап

- Планирование завершено (все функции покрыты): `/madspec.feature.implement`
- Планирование не завершено: запустить `/madspec.feature.plan` снова

