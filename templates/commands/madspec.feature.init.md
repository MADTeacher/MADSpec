---
description: Feature - Инициализация работы над новой функциональностью - анализ существующего проекта, создание ветки, подготовка контекста
scripts:
  sh: scripts/bash/get-branch.sh
  ps: scripts/powershell/get-branch.ps1
---

## Пользовательский ввод

```text
$ARGUMENTS
```

Ты **ОБЯЗАН** учитывать пользовательский ввод перед продолжением (если он не пустой).

## Правила диалога (обязательно)

- **Задавай вопросы строго по одному**: в каждом твоем сообщении должен быть **ровно 1 вопрос**, который требует ответа.
- **Не выдавай список вопросов заранее** (никаких длинных анкет/чек-листов вопросов за раз).
- Если нужен выбор, задай **один вопрос** и предложи **не больше 3–5 вариантов** (или попроси свободный ответ).
- **Дожидайся ответа** и только затем задавай следующий вопрос.
- Если ответ неполный — задай **один уточняющий вопрос**, а не несколько сразу.

## Описание

Эта команда инициализирует работу над новой функциональностью в существующем проекте. Она анализирует существующий проект, создает новую feature ветку и подготавливает контекст для планирования и реализации новой функциональности.

Команда поддерживает два режима работы:

**Режим Feature с MADSpec**: Эта команда предназначена для работы с существующим проектом, который уже инициализирован с MADSpec. Базовые артефакты копируются из основной ветки (например, `main`) в feature ветку, новые артефакты создаются в `.madspec/<feature-branch>/`. Базовые артефакты в основной ветке не изменяются.

**Режим Импорта существующего проекта**: Если проект был создан вручную или с использованием другого фреймворка и не содержит MADSpec артефактов, команда автоматически запустит режим анализа. В этом режиме команда:
- Анализирует структуру и зависимости проекта для определения типа и используемых технологий
- Автоматически создает черновые версии базовых MADSpec артефактов (concept.md, architecture.md, tech-stack.md, project-context.md)
- Интерактивно уточняет детали с пользователем
- Сохраняет артефакты в `.madspec/<main-branch>/` и копирует их в `.madspec/<feature-branch>/`

## Предварительные условия

Эта команда поддерживает два режима работы:

### Режим 1: Проект уже инициализирован с MADSpec
- Проект должен содержать директорию `.madspec/`
- Должны существовать базовые артефакты в основной ветке:
  - `.madspec/<main-branch>/concept.md` (где `<main-branch>` - обычно `main` или `master`)
  - `.madspec/<main-branch>/architecture.md`
  - `.madspec/<main-branch>/tech-stack.md`
- Если файлы отсутствуют, предложи сначала выполнить MVP команды для создания базового проекта
- Базовые артефакты будут скопированы в feature ветку и не будут изменены в основной ветке

### Режим 2: Импорт существующего проекта без MADSpec
- Проект существует (содержит исходный код, конфигурационные файлы)
- Проект может быть создан вручную или с использованием другого фреймворка
- Если базовые MADSpec артефакты отсутствуют, команда автоматически запустит режим анализа и импорта
- В этом режиме будут созданы базовые артефакты на основе анализа существующего проекта
- Артефакты будут сохранены в `.madspec/<main-branch>/` и скопированы в `.madspec/<feature-branch>/`

## Цель этапа

Подготовить работу над новой функциональностью:
- Проанализировать существующий проект и его архитектуру
- Определить контекст и зависимости от существующего кода
- Создать новую feature ветку для разработки
- Подготовить структуру для работы над функциональностью

## Рабочий процесс

0. **Определение веток и подготовка базовых артефактов**:

   **0.1. Определение текущей и основной веток:**
   - Выполни скрипт `{SCRIPT}` для определения текущей ветки
   - Определи основную ветку проекта:
     1. Проверь наличие `.madspec/main/` → если есть, `main` — основная ветка
     2. Иначе проверь наличие `.madspec/master/` → если есть, `master` — основная ветка
     3. Иначе выполни `git branch -r` для получения списка удаленных веток
     4. Если найдена `origin/main` или `origin/master` → используй её как основную
     5. Если git недоступен, используй `main` по умолчанию
   - Сохрани имена текущей и основной веток для использования в дальнейших шагах

   **0.2. Создание feature ветки:**
   - Создай новую ветку для разработки функциональности:
     - Используй формат `feature/<short-name>` (например, `feature/user-auth`, `feature/payment`)
     - Выполни: `git checkout -b <feature-branch-name>`
   - Если git недоступен, используй текущую ветку

   **0.3. Создание директории артефактов фичи:**
   - Создай директорию: `.madspec/<feature-branch>/` (где `<feature-branch>` — имя ветки из шага 0.2)

   **0.4. Копирование базовых артефактов из основной ветки:**
   - Проверь наличие базовых артефактов в `.madspec/<main-branch>/`:
     - concept.md
     - architecture.md
     - tech-stack.md
   - Если все базовые артефакты существуют:
     - Скопируй их в `.madspec/<feature-branch>/`
     - Добавь в начало каждого скопированного файла комментарий:
       ```markdown
       <!-- 
       Этот артефакт был скопирован из основной ветки <main-branch>
       Дата копирования: <YYYY-MM-DD>
       
       При необходимости обновите этот артефакт, если он не соответствует
       текущему состоянию проекта.
       -->
       ```
     - Перейти к шагу 1 (анализ существующих артефактов)
   - Если базовые артефакты отсутствуют:
     - Перейти к шагу 0.5 (режим анализа и импорта существующего проекта)

0.5. **Анализ и импорт существующего проекта**:

   **ВАЖНО**: Этот шаг выполняется только если базовые MADSpec артефакты отсутствуют в основной ветке.

   **0.5.1. Анализ существующего проекта:**
   - Проанализируй структуру проекта для определения типа и технологий
   - Детали анализа описаны в текущем шаблоне (шаги 0.6.1-0.6.3)

   **0.5.2. Создание базовых артефактов:**
   - Создай черновые версии базовых артефактов:
     - tech-stack.md
     - concept.md
     - architecture.md
     - project-context.md
   - Уточни детали с пользователем по одному вопросу за раз

   **0.5.3. Сохранение базовых артефактов:**
   - Сохрани артефакты в `.madspec/<main-branch>/`
   - Скопируй созданные артефакты в `.madspec/<feature-branch>/`
   - Добавь комментарий о создании артефактов

1. **Анализ существующего проекта**:
   - Прочитай базовые артефакты из основной ветки:
     - `.madspec/<main-branch>/concept.md` - для понимания целей проекта
     - `.madspec/<main-branch>/architecture.md` - для понимания текущей архитектуры
     - `.madspec/<main-branch>/tech-stack.md` - для понимания технологического стека
     - `.madspec/<main-branch>/data-model.md` - для понимания модели данных (если существует)
     - `.madspec/<main-branch>/project-context.md` - для понимания контекста проекта
   - Проанализируй существующий код проекта:
     - Определи структуру проекта
     - Определи основные компоненты и их взаимодействие
     - Определи паттерны и подходы, используемые в проекте

2. **Определение новой функциональности**:
   - На основе пользовательского ввода определи:
     - Какую функциональность нужно добавить
     - Какие компоненты затронет новая функциональность
     - Какие зависимости от существующего кода
   - Если пользовательский ввод неполный, задай уточняющие вопросы:
     - "Какую функциональность нужно добавить?"
     - "Какие компоненты системы затронет эта функциональность?"
     - "Есть ли зависимости от существующих функций?"

3. **Подготовка контекста feature работы**:
   - Создай файл `.madspec/<feature-branch>/feature-context.md`:
     - Описание новой функциональности
     - Связь с базовыми артефактами из основной ветки (ссылки на concept, architecture, tech-stack)
     - Зависимости от существующего кода
     - Цели и ограничения новой функциональности
     - Компоненты, которые будут затронуты
   - Укажи, что базовые артефакты находятся в `.madspec/<feature-branch>/`

4. **Валидация готовности к планированию**:

   **ВАЖНО**: Перед завершением выполни валидацию по следующему чек-листу:

   **Обязательные пункты для обоих режимов:**

   - [ ] **Текущая и основная ветка определены**
     - Выполнен скрипт `{SCRIPT}` для определения текущей ветки
     - Определена основная ветка проекта (main/master)
     - Сохранены имена веток для использования в дальнейших шагах
     - **Если не выполнено**: вернись к шагу 0.1

   - [ ] **Feature ветка создана**
     - Создана новая ветка для разработки (или определена текущая)
     - Создана директория `.madspec/<feature-branch>/`
     - **Если не выполнено**: вернись к шагу 0.2

   - [ ] **Новая функциональность четко определена**
     - Описана функциональность, которую нужно добавить
     - Определены компоненты, которые будут затронуты
     - **Если не выполнено**: вернись к шагу 2 и задай уточняющие вопросы

   - [ ] **Контекст feature работы подготовлен**
     - Создан файл `.madspec/<feature-branch>/feature-context.md` с описанием функциональности
     - Указано, что базовые артефакты находятся в `.madspec/<feature-branch>/`
     - **Если не выполнено**: вернись к шагу 3 и создай контекст

   **Дополнительные пункты для режима Импорта (если выполнялся шаг 0.5):**

   - [ ] **Тип проекта определен**
     - Определен язык программирования
     - Определен фреймворк (если применимо)
     - **Если не выполнено**: выполнить анализ структуры проекта (шаг 0.5.1)

   - [ ] **Базовая документация проанализирована**
     - Прочитан README.md или другая документация
     - Понято назначение проекта
     - **Если не выполнено**: проанализировать доступную документацию (шаг 0.5.1)

   - [ ] **Структура проекта проанализирована**
     - Определены основные директории
     - Определены основные компоненты
     - **Если не выполнено**: проанализировать структуру проекта (шаг 0.5.1)

   - [ ] **Черновые артефакты созданы**
     - Создан tech-stack.md на основе зависимостей
     - Создан concept.md с базовой информацией
     - Создан architecture.md на основе структуры
     - Создан project-context.md
     - **Если не выполнено**: создать черновые артефакты (шаг 0.5.2)

   - [ ] **Артефакты уточнены с пользователем**
     - Пользователь проверил сгенерированные артефакты
     - Внесены правки по запросу пользователя
     - **Если не выполнено**: задать уточняющие вопросы (шаг 0.5.2)

   - [ ] **Артефакты сохранены**
     - Артефакты сохранены в `.madspec/<main-branch>/`
     - Артефакты скопированы в `.madspec/<feature-branch>/`
     - **Если не выполнено**: сохранить артефакты (шаг 0.5.3)

   **Дополнительные пункты для режима MADSpec (если пропущен шаг 0.5):**

   - [ ] **Базовые артефакты скопированы в feature ветку**
     - Базовые артефакты из `.madspec/<main-branch>/` скопированы в `.madspec/<feature-branch>/`
     - Добавлен комментарий о копировании с датой
     - **Если не выполнено**: вернись к шагу 0.4 и скопируй артефакты

   - [ ] **Базовые артефакты прочитаны и поняты**
     - Прочитаны concept, architecture, tech-stack из `.madspec/<feature-branch>/`
     - Понята текущая архитектура проекта
     - **Если не выполнено**: прочитай недостающие артефакты (шаг 1)

   - [ ] **Зависимости от существующего кода определены**
     - Определены компоненты, от которых зависит новая функциональность
     - Определены паттерны, которые нужно использовать
     - **Если не выполнено**: проанализируй зависимости (шаг 1)

   **Если валидация не пройдена:**
   - Укажи конкретные пункты, которые не выполнены
   - Предложи конкретные исправления
   - **НЕ ПЕРЕХОДИ** к следующему этапу до прохождения валидации

   **Если валидация пройдена:**
   - Подтверди успешную валидацию
   - Переходи к следующему этапу

6. **Отчет**:
   - Выведи информацию о созданной feature ветке
   - Выведи путь к файлу контекста: `.madspec/<feature-branch>/feature-context.md`
   - Предложи перейти к планированию функциональности: `/madspec.feature.plan`

## Правила

### Общие правила (для обоих режимов)

- **АНАЛИЗИРУЙ** существующий проект перед началом работы
- **СЛЕДУЙ** существующим паттернам и подходам проекта
- **НЕ ИЗМЕНЯЙ** базовые артефакты из основной ветки
- **СОЗДАВАЙ** новые артефакты в feature ветке

### Правила для режима Импорта существующих проектов

- **АНАЛИЗИРУЙ** существующую документацию и структуру проекта
- **НЕ ПРЕДПОЛАГАЙ**, что проект следует MADSpec конвенциям
- **СОХРАНЯЙ** существующие паттерны и подходы проекта
- **СОЗДАВАЙ** MADSpec артефакты как надстройку над существующей документацией
- **УТОЧНЯЙ** детали с пользователем через диалог (строго по одному вопросу за раз)
- **ИСПОЛЬЗУЙ** существующую документацию (README, API спецификации) как источник истины
- **ДЕТЕКТИРУЙ** технологии и фреймворки автоматически из конфигурационных файлов
- **ПОКАЗЫВАЙ** пользователю сгенерированные артефакты для проверки перед сохранением

### Технические детали анализа

Для автоматического анализа используй следующие правила:

**Детекция языка и фреймворков**:
- JavaScript/TypeScript: package.json → dependencies, devDependencies, engines
- Python: pyproject.toml → dependencies, requires-python, optional-dependencies
- Java (Maven): pom.xml → dependencies, properties
- Java (Gradle): build.gradle → dependencies, plugins
- Go: go.mod → require, go version
- Rust: Cargo.toml → dependencies, dev-dependencies
- Flutter/Dart: pubspec.yaml → dependencies, dev_dependencies, flutter, environment

**Детекция популярных фреймворков**:
- React: `react`, `react-dom` в dependencies
- Vue: `vue`, `@vue/...` в dependencies
- Angular: `@angular/...` в dependencies
- Next.js: `next`, `react` в dependencies
- Express: `express` в dependencies
- Django: `django` в dependencies
- FastAPI: `fastapi`, `uvicorn` в dependencies
- Spring Boot: `spring-boot-starter` в dependencies
- Flutter: проверяется по наличию pubspec.yaml и директории lib/, flutter SDK в environment

**Детекция баз данных**:
- PostgreSQL: `pg`, `sequelize`, `typeorm`, `psycopg2`
- MySQL: `mysql`, `mysql2`, `pymysql`
- MongoDB: `mongodb`, `mongoose`, `pymongo`
- SQLite: `sqlite3`, `better-sqlite3`

## Выходные артефакты

- `.madspec/<feature-branch>/feature-context.md` - контекст работы над новой функциональностью (где `<feature-branch>` - имя feature ветки)
- Директория `.madspec/<feature-branch>/` - подготовлена для артефактов feature работы

## Следующий этап

После завершения инициализации переходите к `/madspec.feature.plan` для планирования новой функциональности.
