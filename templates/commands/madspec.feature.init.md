---
description: Feature - Инициализация работы над новой функциональностью - анализ проекта, автогенерация MADSpec артефактов, определение точек интеграции
scripts:
  sh: scripts/bash/get-branch.sh
  ps: scripts/powershell/get-branch.ps1
---

## Пользовательский ввод

```text
$ARGUMENTS
```

Ты **ОБЯЗАН** учитывать пользовательский ввод перед продолжением (если он не пустой).

## Правила диалога (обязательно)

- **Задавай вопросы строго по одному**: в каждом твоем сообщении должен быть **ровно 1 вопрос**, который требует ответа.
- **Не выдавай список вопросов заранее** (никаких длинных анкет/чек-листов вопросов за раз).
- Если нужен выбор, задай **один вопрос** и предложи **не больше 3–5 вариантов** (или попроси свободный ответ).
- **Дожидайся ответа** и только затем задавай следующий вопрос.
- Если ответ неполный — задай **один уточняющий вопрос**, а не несколько сразу.

## Описание

Эта команда инициализирует работу над новой функциональностью в существующем проекте. Она:

1. **Анализирует существующий проект** — структуру, технологии, паттерны, точки интеграции
2. **Автоматически генерирует MADSpec артефакты** на основе анализа кода
3. **Определяет где и как встроить новое** — находит точки интеграции в существующем коде
4. **Создает feature ветку** и подготавливает структуру для работы

**Результат:** готовность к планированию и реализации без предварительных артефактов.

## Предварительные условия

- Проект с исходным кодом (любой язык/фреймворк)
- Git репозиторий (для создания ветки)
- **Никаких предварительных MADSpec артефактов не требуется**

## Цель этапа

Подготовить полноценный контекст для работы над функциональностью:
- Понять что есть в проекте и как оно устроено
- Определить точки интеграции для новой функциональности
- Создать все необходимые MADSpec артефакты автоматически
- Подготовить структуру для планирования и реализации

## Рабочий процесс

### ⚠️ КРИТИЧЕСКИ ВАЖНО: Оркестрация субагентов и агентских навыков

**ОБЯЗАТЕЛЬНО ВЫПОЛНИ ЭТОТ ШАГ ПЕРВЫМ ПЕРЕД ВСЕМИ ОСТАЛЬНЫМИ ДЕЙСТВИЯМИ:**

1. **Загрузи агенсткий навык (agent skills из из директории .x/skills, где x - название используемой среды разработки. Например - cursor, opencode и т.д.) оркестрации субагентов (`subagents_orchestrator`)**, который отвечает за распределения частей выполняемой команды по специализированным субагентам. 

2. **Используй навык `subagents_orchestrator` для анализа текущей задачи**:
   - Передай навыку описание текущей задачи 
   - Навык проанализирует задачу и вернет структурированный JSON-ответ с рекомендациями:
     - Каких субагентов использовать
     - Режим выполнения (parallel/sequential)
     - Обоснование выбора
   - **ВАЖНО**: Если навык вернул `status: "no_agents"` или список субагентов пуст, переходи к обычному выполнению задачи без использования субагентов

3. **При запуске субагентов**:
  - Если для запускаемого субагента имеется подходящий навык, **ОБЯЗАТЕЛЬНО** передай в промпте, отправляемом на вход субагента, команду по его загрузке
  - **КРИТИЧЕСКИ ВАЖНО**: При вызове инструментов, отвечающих за запуск субагентов, **ВСЕГДА** передавай следующие параметры (если они поддерживаются):
     - `description` - краткое описание задачи
     - `prompt` - детальные инструкции для субагента
     - Тип субагента

4. **Fallback поведение**:
   - Если субагенты недоступны или навык не может быть использован, продолжи обычное выполнение задачи

---

0. **Определение текущей ветки и создание feature ветки:**

   - Выполни скрипт `{SCRIPT}` для определения текущей ветки
   - Определи основную ветку:
     1. Проверь наличие `.madspec/main/` → если есть, `main` — основная
     2. Иначе проверь `git branch -r` для удаленных веток
     3. Если найдена `origin/main` или `origin/master` → используй ее
     4. Если git недоступен, используй `main` по умолчанию
   - Спроси у пользователя: "Какое короткое название для feature ветки?" (например: `user-auth`, `payment`, `notifications`)
   - Создай ветку: `git checkout -b feature/<short-name>`
   - Создай директорию: `.madspec/feature/<short-name>/`

1. **Анализ существующего проекта:**

   **1.1. Определение технологического стека:**

   Автоматически определи язык, фреймворк, зависимости:

   - **JavaScript/TypeScript**: `package.json` → dependencies, devDependencies, engines
   - **Python**: `pyproject.toml` или `requirements.txt` → dependencies
   - **Java (Maven/Gradle)**: `pom.xml` или `build.gradle`
   - **Go**: `go.mod` → require, go version
   - **Rust**: `Cargo.toml` → dependencies
   - **Flutter/Dart**: `pubspec.yaml` → dependencies, environment
   - **Kotlin**: `build.gradle.kts`, `settings.gradle.kts`
   - **C#**: `*.csproj`, `Directory.Build.props`

   Определи фреймворки:
   - Frontend: React, Vue, Angular, Svelte, Next.js, Nuxt, Solid
   - Backend: Express, NestJS, FastAPI, Django, Spring Boot, Gin, Echo
   - Mobile: Flutter, React Native, SwiftUI, Jetpack Compose
   - Database: PostgreSQL, MySQL, MongoDB, SQLite, Redis, Firebase
   - ORM/Query Builders: Prisma, Sequelize, TypeORM, SQLAlchemy, GORM, Eloquent
   - Testing: Jest, Vitest, Pytest, JUnit, Mocha, Cypress, Playwright
   - Build/CI: Vite, Webpack, Cargo, Maven, Gradle, npm scripts

   **1.2. Анализ структуры проекта:**

   Исследуй структуру директорий:
   - Определи source directories (`src/`, `lib/`, `app/`, `packages/`)
   - Найди конфигурационные файлы
   - Определи структуру тестов
   - Найди documentation файлы (README, docs/)

   **1.3. Анализ архитектуры и паттернов:**

   Проанализируй исходный код для понимания:
   - **Frontend**:
     - Component structure (pages, components, layouts)
     - State management (context, redux, mobx, signals)
     - Routing (react-router, vue-router, next.js routes)
     - Styling approach (CSS modules, Tailwind, styled-components)
     - API communication patterns (fetch, axios, react-query, swr)
   - **Backend**:
     - Layer structure (controllers, services, repositories, handlers)
     - API style (REST, GraphQL, gRPC, WebSocket)
     - Database access patterns (ORM, query builder, raw SQL)
     - Authentication/Authorization patterns
     - Middleware/interceptor patterns
   - **Mobile**:
     - Widget/component structure
     - Navigation patterns
     - State management
     - API integration patterns

   **1.4. Поиск точек интеграции:**

   На основе анализа определи куда интегрировать новую функциональность:
   - Какие файлы/модули нужно модифицировать
   - Какие новые файлы создать
   - Какие интерфейсы/контракты соблюсти
   - Зависимости от существующих модулей

2. **Интерактивное уточнение (минимум вопросов):**

   После автоматического анализа задай **один вопрос** для уточнения:

   "Я проанализировал проект и понял его структуру. Пожалуйста, опиши что нужно добавить:
   
   1. Что конкретно должна делать новая функциональность?
   2. Какие существующие модули/компоненты она должна использовать?
   3. Есть ли внешние интеграции (API, сервисы)?"
   
   Пользователь отвечает текстом — используй этот ответ для уточнения артефактов.

3. **Автогенерация MADSpec артефактов:**

   На основе анализа + ответа пользователя создай:

   **3.1. `tech-stack.md`:**
   ```markdown
   # Технологический стек

   ## Язык программирования
   - [Определено из анализа]

   ## Фреймворки и библиотеки
   - [Список из package.json/pyproject.toml/etc]

   ## База данных
   - [Определено из анализа]

   ## Тестирование
   - [Список тестовых фреймворков]

   ## Инструменты сборки
   - [Определено из анализа]

   ## Дополнительные инструменты
   - [Линтеры, форматтеры, CI/CD]
   ```

   **3.2. `concept.md`:**
   На основе ответа пользователя + анализа структуры:
   ```markdown
   # Концепция

   ## Цель
   [Что делает новая функциональность - из ответа пользователя]

   ## Для кого
   [Целевая аудитория - вывести из контекста или спросить]

   ## Проблема
   [Какую проблему решает - из ответа пользователя]

   ## Ожидаемый результат
   [Что получим в итоге]

   ## Функции (P1/P2/P3)
   - **P1** (критично): [Основные функции]
   - **P2** (важно): [Дополнительные функции]
   - **P3** (желательно): [Будущие улучшения]
   ```

   **3.3. `architecture.md`:**
   На основе анализа существующей архитектуры + новая функциональность:
   ```markdown
   # Архитектура

   ## Текущая структура
   [Краткое описание существующей архитектуры из анализа]

   ## Предлагаемые изменения
   [Как новая функциональность вписывается в существующую архитектуру]

   ## Компоненты
   - **Существующие**: [Какие компоненты используем]
   - **Новые**: [Какие компоненты создаем]

   ## Интеграция
   [Как интегрируем с существующим кодом - из analysis]

   ## Потоки данных
   [Как данные проходят через систему]
   ```

   **3.4. `project-analysis.md` (КЛЮЧЕВОЙ АРТЕФАКТ):**
   Используй шаблон `templates/feature/project-analysis-template.md` для создания этого файла.
   Этот файл — результат анализа проекта и функциональных требований для новой функциональности.

   Ключевые секции шаблона:
   - **Функциональные требования (P1/P2/P3)** — функции с привязкой к файлам
   - **Точки интеграции** — файлы для модификации и создания
   - **Зависимости** — от существующих модулей и внешние
   - **Рекомендации** — как встроить новую функциональность

   **3.5. `feature-context.md`:**
   ```markdown
   # Контекст Feature

   ## Описание функциональности
   [Краткое описание из project-analysis.md - обзор функций P1/P2/P3]

   ## Цель и проблема (из concept.md)
   [Если concept.md создан - ссылка на него, иначе - кратко]
   ```

   **3.6. `project-context.md`:**
   ```markdown
   # Контекст проекта

   ## Текущий этап
   - **Этап**: `init` (инициализация)
   - **Статус**: Готов к планированию

   ## Артефакты
   - [Список созданных артефактов с путями]

   ## Следующий шаг
   Запустить `/madspec.feature.plan` для планирования шагов реализации
   ```

4. **Создание структуры для планирования:**

   - Создай `.madspec/feature/<short-name>/steps/`
   - Создай `.madspec/feature/<short-name>/memory/`
   - Создай `.madspec/feature/<short-name>/memory/progress.json` используя шаблон `templates/planning-state-template.json`:

5. **Валидация готовности:**

   **Обязательные пункты:**

   - [ ] **Feature ветка создана**
     - Выполнен `git checkout -b feature/<short-name>`
     - Создана директория `.madspec/feature/<short-name>/`
   
   - [ ] **Технологический стек определен**
     - Создан `tech-stack.md`
     - Определены язык, фреймворк, зависимости
   
   - [ ] **Концепция создана**
     - Создан `concept.md` (опционально)
     - Если создан — определены функции P1/P2/P3
   
   - [ ] **Анализ проекта выполнен**
     - Создан `project-analysis.md` (по шаблону templates/feature/project-analysis-template.md)
     - Определены функции P1/P2/P3 с привязкой к файлам
     - Определены точки интеграции
     - Найдены файлы для модификации/создания
   
   - [ ] **Архитектура описана**
     - Создан `architecture.md`
     - Описаны изменения для новой функциональности
   
   - [ ] **Контекст feature готов**
     - Создан `feature-context.md`
     - Создан `project-context.md`
   
   - [ ] **Структура для планирования создана**
     - Созданы `steps/`, `memory/`
     - Создан `progress.json`

6. **Отчет:**

   Выведи:
   - Feature ветка: `feature/<short-name>`
   - Созданные артефакты:
     - `.madspec/feature/<short-name>/tech-stack.md`
     - `.madspec/feature/<short-name>/concept.md` (опционально)
     - `.madspec/feature/<short-name>/architecture.md`
     - `.madspec/feature/<short-name>/project-analysis.md` (ключевой)
     - `.madspec/feature/<short-name>/feature-context.md`
     - `.madspec/feature/<short-name>/project-context.md`
   - Ключевые функции из project-analysis.md:
     - P1: [список]
     - P2: [список]
     - P3: [список]
   - Предложение: "Готов к планированию. Запустить `/madspec.feature.plan`?"

## Правила

- **АНАЛИЗИРУЙ** проект автоматически перед вопросами
- **СПРАШИВАЙ** минимум — только то, что нельзя вывести из кода
- **ГЕНЕРИРУЙ** артефакты на основе анализа + пользовательского ввода
- **ОПРЕДЕЛЯЙ** конкретные файлы для интеграции
- **НЕ ТРЕБУЙ** предварительных MADSpec артефактов

## Выходные артефакты

- `.madspec/feature/<short-name>/tech-stack.md` — технологический стек
- `.madspec/feature/<short-name>/concept.md` — концепция функциональности (опционально)
- `.madspec/feature/<short-name>/architecture.md` — архитектура изменений
- `.madspec/feature/<short-name>/project-analysis.md` — анализ + функции P1/P2/P3 + точки интеграции (ключевой)
- `.madspec/feature/<short-name>/feature-context.md` — контекст feature
- `.madspec/feature/<short-name>/project-context.md` — навигация по проекту
- `.madspec/feature/<short-name>/memory/progress.json` — трекинг прогресса
- `.madspec/feature/<short-name>/steps/` — директория для шагов

## Следующий этап

После завершения запустите `/madspec.feature.plan` для планирования шагов реализации.

